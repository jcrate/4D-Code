  // ----------------------------------------------------  // User name (OS): jcrate  // Date and time: 01/11/08, 09:56:54  // Modified by: James Crate (03/17/13) added 401 handling with HTTP Digest support  // ----------------------------------------------------  // Method: HTTP_Get  // ----------------------------------------------------C_LONGINT($0;$response_code)$response_code:=0C_TEXT($1;$url)$url:=$1C_POINTER($2;$response_ptr)$response_ptr:=$2C_TEXT($3;$username)If (Count parameters>=3)$username:=$3End if C_TEXT($4;$password)If (Count parameters>=4)$password:=$4End if   // ----------------------------------------------------C_LONGINT($port;$scheme;$stream_ref;$err;$stream_state;$settings;$auth_idx;$count)C_TEXT($host;$path;$request;$un_passwd;$hash1;$hash2;$response_hash;$cnonce;$nonce_count)C_BLOB($response;$header;$auth_header)  // ----------------------------------------------------$port:=URL_Extract_Port ($url)$host:=URL_Extract_Host ($url)$path:=URL_Extract_Path_w_Params ($url)$settings:=0If ($port=0)$scheme:=URL_Extract_Scheme_i ($url)Case of : ($scheme=URL_Scheme_HTTP)$port:=80: ($scheme=URL_Scheme_HTTPS)$port:=443$settings:=2End case Else If ($port=443)$settings:=2End if End if $request:="GET "+$path+" HTTP/1.1\r\n"$request:=$request+"Host: "+$host+"\r\n"$request:=$request+"Connection: close\r\n"$request:=$request+"\r\n"  //ERROR_Dump_LogEntry ("HTTP GET to: "+$host)  //ERROR_Dump_LogEntry ($request+"\r\r")SET BLOB SIZE($response_ptr->;0)$err:=TCP_Open ($host;$port;$stream_ref;$settings)If ($err=0)$err:=TCP_Send ($stream_ref;$request)Repeat $err:=TCP_ReceiveBLOB ($stream_ref;$response)$err:=TCP_State ($stream_ref;$stream_state)COPY BLOB($response;$response_ptr->;0;BLOB size($response_ptr->);BLOB size($response))Until (($stream_state=0) | ($err#0))$err:=TCP_Close ($stream_ref)  //ERROR_Dump_LogEntry ("HTTP response from: "+$host)  //ERROR_Dump_LogEntry (BLOB to text($response_ptr->;UTF8 text without length)+"\r\r")Else ERROR_Dump_LogEntry ("HTTP Connection failed with code: "+String($err))End if   //rip header off response, and get response code from that$response_code:=HTTP_Process_Response ($response_ptr;->$header)If ($response_code=401)  //ERROR_Dump_LogEntry ("401 header: \n"+BLOB to text($header;UTF8 text without length))ARRAY TEXT($header_keys;0)ARRAY TEXT($header_values;0)$count:=BLOB_Parse_to_Arrays_x (->$header;":";"\r\n";->$header_keys;->$header_values)$auth_idx:=Find in array($header_keys;"WWW-Authenticate@")If ($auth_idx>0)$request:="GET "+$path+" HTTP/1.1\r\n"$request:=$request+"Host: "+$host+"\r\n"$request:=$request+"Connection: close\r\n"Case of : ($header_values{$auth_idx}=" Basic@")$un_passwd:=$username+":"+$password$un_passwd:=CODEC_Encode_Base64_x ($un_passwd)$request:=$request+"Authorization: Basic "+$un_passwd+"\r\n": ($header_values{$auth_idx}=" Digest@")TEXT TO BLOB($header_values{$auth_idx}+"  ";$auth_header;UTF8 text without length)$nonce:=BLOB_Finds_Between_Folding_x (->$auth_header;"nonce=\"";"\"";"")$realm:=BLOB_Finds_Between_Folding_x (->$auth_header;"realm=\"";"\"";"")$algorithm:=Replace string(BLOB_Finds_Between_Folding_x (->$auth_header;"algorithm=";" ";"");"\"";"")$algorithm:=Replace string($algorithm;",";"")$qop:=Replace string(BLOB_Finds_Between_Folding_x (->$auth_header;"qop=";" ";"");"\"";"")$cnonce:=CODEC_Encode_MD5_xx (String(Milliseconds))$nonce_count:="00000001"Case of : (($algorithm="MD5") | ($algorithm=""))$hash1:=CODEC_Encode_MD5_xx ($username+":"+$realm+":"+$password): ($algorithm="MD5-sess")$hash1:=CODEC_Encode_MD5_xx ($username+":"+$realm+":"+$password)$hash1:=CODEC_Encode_MD5_xx ($hash1+":"+$nonce+":"+$cnonce)End case Case of : (($qop="auth") | ($qop=""))$hash2:=CODEC_Encode_MD5_xx ("GET:"+$path): ($qop="auth-int")  // only useful for POST requests? it would hash the body$hash2:=CODEC_Encode_MD5_xx ("")$hash2:=CODEC_Encode_MD5_xx ("GET:"+$path+":"+$hash2)End case Case of : ($qop="auth@")$response_hash:=CODEC_Encode_MD5_xx ($hash1+":"+$nonce+":"+$nonce_count+":"+$cnonce+":"+$qop+":"+$hash2): ($qop="")$response_hash:=CODEC_Encode_MD5_xx ($hash1+":"+$nonce+":"+$hash2)End case $digest_header:="Digest username=\""+$username+"\", realm=\""+$realm+"\", "If ($qop#"")$digest_header:=$digest_header+"nonce=\""+$nonce+"\", cnonce=\""+$cnonce+"\", "End if $digest_header:=$digest_header+"uri=\""+$path+"\", response=\""+$response_hash+"\", qop=\""+$qop+"\", "$digest_header:=$digest_header+"nc="+$nonce_count+", algorithm="+$algorithm$request:=$request+"Authorization: "+$digest_header+"\r\n"Else   // unknown, can't do anythingEnd case $request:=$request+"\r\n"  //ERROR_Dump_LogEntry ("Authenticated Request: \n"+BLOB to text($header;UTF8 text without length))  // try again with authorizationSET BLOB SIZE($response_ptr->;0)$err:=TCP_Open ($host;$port;$stream_ref;$settings)If ($err=0)$err:=TCP_Send ($stream_ref;$request)Repeat $err:=TCP_ReceiveBLOB ($stream_ref;$response)$err:=TCP_State ($stream_ref;$stream_state)COPY BLOB($response;$response_ptr->;0;BLOB size($response_ptr->);BLOB size($response))Until (($stream_state=0) | ($err#0))$err:=TCP_Close ($stream_ref)  //ERROR_Dump_LogEntry ("HTTP response from: "+$host)  //ERROR_Dump_LogEntry (BLOB to text($response_ptr->;Text without length)+"\r\r")End if   //rip header off response, and get response code from that$response_code:=HTTP_Process_Response ($response_ptr;->$header)  //ERROR_Dump_LogEntry (String($response_code)+" header: \n"+BLOB to text($header;UTF8 text without length))End if End if $0:=$response_code